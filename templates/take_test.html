{% extends "base_student_sidebar.html" %}

{% block title %}Take Test - College ERP{% endblock %}

{% block extra_css %}
<style>
    .test-container {
        padding: 2rem;
        max-width: 1000px;
        margin: 0 auto;
    }

    .test-header {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
        border: 1px solid rgba(255, 255, 255, 0.2);
        text-align: center;
    }

    .test-title {
        font-size: 2rem;
        font-weight: bold;
        color: white;
        margin-bottom: 1rem;
    }

    .test-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .info-item {
        background: rgba(255, 255, 255, 0.05);
        padding: 1rem;
        border-radius: 10px;
        text-align: center;
    }

    .info-label {
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }

    .info-value {
        color: white;
        font-size: 1.2rem;
        font-weight: bold;
    }

    .timer {
        background: linear-gradient(135deg, #e74c3c, #f39c12);
        color: white;
        padding: 1rem 2rem;
        border-radius: 15px;
        font-size: 1.5rem;
        font-weight: bold;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .timer.warning {
        background: linear-gradient(135deg, #f39c12, #e67e22);
        animation: pulse 1s infinite;
    }

    .timer.danger {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        animation: pulse 0.5s infinite;
    }

    @keyframes pulse {
        0%, 100% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.05);
        }
    }

    .question-container {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .question-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .question-number {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: bold;
    }

    .question-points {
        background: linear-gradient(135deg, #56ab2f, #a8e6cf);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: bold;
    }

    .question-text {
        color: white;
        font-size: 1.2rem;
        line-height: 1.6;
        margin-bottom: 1.5rem;
    }

    .question-options {
        display: grid;
        gap: 1rem;
    }

    .option-item {
        background: rgba(255, 255, 255, 0.05);
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 15px;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .option-item:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(86, 171, 47, 0.5);
        transform: translateY(-2px);
    }

    .option-item.selected {
        background: rgba(86, 171, 47, 0.2);
        border-color: #56ab2f;
    }

    .option-radio {
        width: 20px;
        height: 20px;
        accent-color: #56ab2f;
    }

    .option-text {
        color: white;
        font-size: 1.1rem;
        flex: 1;
    }

    .short-answer-input {
        width: 100%;
        padding: 1rem;
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 15px;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        font-size: 1.1rem;
        resize: vertical;
        min-height: 100px;
    }

    .short-answer-input:focus {
        outline: none;
        border-color: #56ab2f;
        background: rgba(255, 255, 255, 0.15);
    }

    .short-answer-input::placeholder {
        color: rgba(255, 255, 255, 0.6);
    }

    .navigation-buttons {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 2rem;
    }

    .nav-btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 10px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-previous {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
    }

    .btn-next {
        background: linear-gradient(135deg, #56ab2f, #a8e6cf);
        color: white;
    }

    .btn-submit {
        background: linear-gradient(135deg, #e74c3c, #f39c12);
        color: white;
        padding: 1rem 2rem;
        font-size: 1.1rem;
    }

    .nav-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .nav-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    .progress-bar {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        height: 10px;
        margin-bottom: 2rem;
        overflow: hidden;
    }

    .progress-fill {
        background: linear-gradient(135deg, #56ab2f, #a8e6cf);
        height: 100%;
        border-radius: 10px;
        transition: width 0.3s ease;
    }

    .question-list {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }

    .question-nav-btn {
        width: 40px;
        height: 40px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }

    .question-nav-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        border-color: #56ab2f;
    }

    .question-nav-btn.answered {
        background: rgba(86, 171, 47, 0.3);
        border-color: #56ab2f;
    }

    .question-nav-btn.current {
        background: linear-gradient(135deg, #667eea, #764ba2);
        border-color: #667eea;
    }

    @media (max-width: 768px) {
        .test-info {
            grid-template-columns: 1fr;
        }
        
        .navigation-buttons {
            flex-direction: column;
            gap: 1rem;
        }
        
        .nav-btn {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="test-container">
    <div class="test-header">
        <h1 class="test-title">{{ test.title }}</h1>
        <div class="test-info">
            <div class="info-item">
                <div class="info-label">Duration</div>
                <div class="info-value">{{ test.duration_minutes }} minutes</div>
            </div>
            <div class="info-item">
                <div class="info-label">Questions</div>
                <div class="info-value">{{ questions|length }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Total Points</div>
                <div class="info-value">{{ questions|sum(attribute='points') }}</div>
            </div>
        </div>
        <div class="timer" id="timer">
            <i class="fas fa-clock"></i>
            <span id="timeDisplay">00:00</span>
        </div>
    </div>

    <div class="progress-bar">
        <div class="progress-fill" id="progressBar" style="width: 0%"></div>
    </div>

    <div class="question-list" id="questionList">
        {% for question in questions %}
        <button class="question-nav-btn" data-question="{{ loop.index0 }}" onclick="goToQuestion({{ loop.index0 }})">
            {{ loop.index }}
        </button>
        {% endfor %}
    </div>

    <form id="testForm" method="POST">
        {% for question in questions %}
        <div class="question-container" id="question-{{ loop.index0 }}" style="display: {{ 'block' if loop.first else 'none' }}">
            <div class="question-header">
                <span class="question-number">Question {{ loop.index }}</span>
                <span class="question-points">{{ question.points }} points</span>
            </div>
            
            <div class="question-text">{{ question.question_text }}</div>
            
            {% if question.question_type == 'multiple_choice' %}
            <div class="question-options">
                <div class="option-item" onclick="selectOption({{ loop.index0 }}, 'A')">
                    <input type="radio" name="answer_{{ question.id }}" value="A" class="option-radio" id="option_{{ question.id }}_A">
                    <label for="option_{{ question.id }}_A" class="option-text">A) {{ question.option_a or 'Option A' }}</label>
                </div>
                <div class="option-item" onclick="selectOption({{ loop.index0 }}, 'B')">
                    <input type="radio" name="answer_{{ question.id }}" value="B" class="option-radio" id="option_{{ question.id }}_B">
                    <label for="option_{{ question.id }}_B" class="option-text">B) {{ question.option_b or 'Option B' }}</label>
                </div>
                <div class="option-item" onclick="selectOption({{ loop.index0 }}, 'C')">
                    <input type="radio" name="answer_{{ question.id }}" value="C" class="option-radio" id="option_{{ question.id }}_C">
                    <label for="option_{{ question.id }}_C" class="option-text">C) {{ question.option_c or 'Option C' }}</label>
                </div>
                <div class="option-item" onclick="selectOption({{ loop.index0 }}, 'D')">
                    <input type="radio" name="answer_{{ question.id }}" value="D" class="option-radio" id="option_{{ question.id }}_D">
                    <label for="option_{{ question.id }}_D" class="option-text">D) {{ question.option_d or 'Option D' }}</label>
                </div>
            </div>
            {% elif question.question_type == 'true_false' %}
            <div class="question-options">
                <div class="option-item" onclick="selectOption({{ loop.index0 }}, 'True')">
                    <input type="radio" name="answer_{{ question.id }}" value="True" class="option-radio" id="option_{{ question.id }}_True">
                    <label for="option_{{ question.id }}_True" class="option-text">True</label>
                </div>
                <div class="option-item" onclick="selectOption({{ loop.index0 }}, 'False')">
                    <input type="radio" name="answer_{{ question.id }}" value="False" class="option-radio" id="option_{{ question.id }}_False">
                    <label for="option_{{ question.id }}_False" class="option-text">False</label>
                </div>
            </div>
            {% elif question.question_type == 'short_answer' %}
            <textarea name="answer_{{ question.id }}" class="short-answer-input" placeholder="Enter your answer here..."></textarea>
            {% elif question.question_type == 'essay' %}
            <textarea name="answer_{{ question.id }}" class="short-answer-input" placeholder="Write your essay here..." style="min-height: 200px;"></textarea>
            {% endif %}
        </div>
        {% endfor %}

        <div class="navigation-buttons">
            <button type="button" class="nav-btn btn-previous" id="prevBtn" onclick="previousQuestion()" disabled>
                <i class="fas fa-arrow-left"></i>
                Previous
            </button>
            <button type="button" class="nav-btn btn-next" id="nextBtn" onclick="nextQuestion()">
                Next
                <i class="fas fa-arrow-right"></i>
            </button>
            <button type="submit" class="nav-btn btn-submit" id="submitBtn" onclick="submitTest()" style="display: none;">
                <i class="fas fa-check"></i>
                Submit Test
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentQuestion = 0;
    let totalQuestions = {{ questions|length }};
    let timeRemaining = {{ test.duration_minutes * 60 }};
    let timerInterval;
    let answers = {};

    function initTest() {
        updateProgress();
        updateNavigationButtons();
        startTimer();
        loadSavedAnswers();
    }

    function startTimer() {
        timerInterval = setInterval(() => {
            timeRemaining--;
            updateTimerDisplay();
            
            if (timeRemaining <= 0) {
                clearInterval(timerInterval);
                submitTest();
            }
        }, 1000);
    }

    function updateTimerDisplay() {
        const minutes = Math.floor(timeRemaining / 60);
        const seconds = timeRemaining % 60;
        const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        document.getElementById('timeDisplay').textContent = timeString;
        
        const timer = document.getElementById('timer');
        timer.className = 'timer';
        
        if (timeRemaining <= 300) { // 5 minutes
            timer.classList.add('danger');
        } else if (timeRemaining <= 600) { // 10 minutes
            timer.classList.add('warning');
        }
    }

    function goToQuestion(questionIndex) {
        // Hide current question
        document.getElementById(`question-${currentQuestion}`).style.display = 'none';
        
        // Update current question
        currentQuestion = questionIndex;
        
        // Show new question
        document.getElementById(`question-${currentQuestion}`).style.display = 'block';
        
        // Update navigation
        updateNavigationButtons();
        updateQuestionList();
    }

    function nextQuestion() {
        if (currentQuestion < totalQuestions - 1) {
            goToQuestion(currentQuestion + 1);
        }
    }

    function previousQuestion() {
        if (currentQuestion > 0) {
            goToQuestion(currentQuestion - 1);
        }
    }

    function updateNavigationButtons() {
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const submitBtn = document.getElementById('submitBtn');
        
        prevBtn.disabled = currentQuestion === 0;
        
        if (currentQuestion === totalQuestions - 1) {
            nextBtn.style.display = 'none';
            submitBtn.style.display = 'flex';
        } else {
            nextBtn.style.display = 'flex';
            submitBtn.style.display = 'none';
        }
    }

    function updateQuestionList() {
        const questionBtns = document.querySelectorAll('.question-nav-btn');
        questionBtns.forEach((btn, index) => {
            btn.classList.remove('current');
            if (index === currentQuestion) {
                btn.classList.add('current');
            }
        });
    }

    function selectOption(questionIndex, value) {
        // Find the radio button and check it
        const question = questions[questionIndex];
        const radio = document.querySelector(`input[name="answer_${question.id}"][value="${value}"]`);
        if (radio) {
            radio.checked = true;
        }
        
        // Update visual selection
        const optionItems = document.querySelectorAll(`#question-${questionIndex} .option-item`);
        optionItems.forEach(item => {
            item.classList.remove('selected');
        });
        
        const selectedItem = document.querySelector(`#question-${questionIndex} .option-item[onclick*="${value}"]`);
        if (selectedItem) {
            selectedItem.classList.add('selected');
        }
        
        // Mark question as answered
        markQuestionAnswered(questionIndex);
        saveAnswer(questionIndex, value);
    }

    function markQuestionAnswered(questionIndex) {
        const questionBtn = document.querySelector(`[data-question="${questionIndex}"]`);
        questionBtn.classList.add('answered');
    }

    function saveAnswer(questionIndex, value) {
        answers[questionIndex] = value;
        updateProgress();
    }

    function loadSavedAnswers() {
        // Load answers from localStorage or form data
        const form = document.getElementById('testForm');
        const formData = new FormData(form);
        
        for (let [name, value] of formData.entries()) {
            if (name.startsWith('answer_')) {
                const questionId = name.split('_')[1];
                const questionIndex = Array.from(questions).findIndex(q => q.id == questionId);
                if (questionIndex !== -1) {
                    answers[questionIndex] = value;
                    markQuestionAnswered(questionIndex);
                }
            }
        }
    }

    function updateProgress() {
        const answeredQuestions = Object.keys(answers).length;
        const progress = (answeredQuestions / totalQuestions) * 100;
        document.getElementById('progressBar').style.width = progress + '%';
    }

    function submitTest() {
        if (confirm('Are you sure you want to submit the test? You cannot change your answers after submission.')) {
            clearInterval(timerInterval);
            document.getElementById('testForm').submit();
        }
    }

    // Initialize test when page loads
    document.addEventListener('DOMContentLoaded', function() {
        initTest();
        
        // Auto-save answers every 30 seconds
        setInterval(() => {
            // Save current answers to localStorage
            localStorage.setItem('test_answers', JSON.stringify(answers));
        }, 30000);
        
        // Load answers from localStorage
        const savedAnswers = localStorage.getItem('test_answers');
        if (savedAnswers) {
            answers = JSON.parse(savedAnswers);
            updateProgress();
        }
    });

    // Prevent accidental page refresh
    window.addEventListener('beforeunload', function(e) {
        if (timeRemaining > 0) {
            e.preventDefault();
            e.returnValue = '';
        }
    });
</script>
{% endblock %}
